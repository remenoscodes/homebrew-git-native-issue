name: Update Formula

on:
  repository_dispatch:
    types: [formula-update]

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update formula
        env:
          VERSION: ${{ github.event.client_payload.version }}
          SHA256: ${{ github.event.client_payload.sha256 }}
          URL: ${{ github.event.client_payload.url }}
        run: |
          echo "Updating formula to version $VERSION"
          echo "  SHA256: $SHA256"
          echo "  URL: $URL"

          # Update formula file
          sed -i "s|url \".*\"|url \"$URL\"|g" git-native-issue.rb
          sed -i "s|sha256 \".*\"|sha256 \"$SHA256\"|g" git-native-issue.rb
          sed -i "s|version \".*\"|version \"$VERSION\"|g" git-native-issue.rb

          # Verify changes
          if git diff --quiet git-native-issue.rb; then
            echo "⚠️  No changes detected - formula already up to date"
            exit 0
          fi

          echo "✓ Formula updated successfully"
          git diff git-native-issue.rb

      - name: Commit and push
        env:
          VERSION: ${{ github.event.client_payload.version }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit changes
          git add git-native-issue.rb
          git commit -m "Update formula to v${VERSION}" \
                     -m "" \
                     -m "Automated update triggered by release workflow:" \
                     -m "- Version: $VERSION" \
                     -m "- SHA256: ${{ github.event.client_payload.sha256 }}" \
                     -m "" \
                     -m "This commit was automatically generated by GitHub Actions."

          # Push to main
          git push origin main

          echo "✓ Formula update committed and pushed"
          echo ""
          echo "Users can now install with:"
          echo "  brew update"
          echo "  brew install remenoscodes/git-native-issue/git-native-issue"
